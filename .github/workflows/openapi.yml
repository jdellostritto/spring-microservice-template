name: Generate & Publish OpenAPI Spec

on:
  push:
    branches: [ master, develop ]
  workflow_dispatch:

jobs:
  openapi:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Build project
        run: ./gradlew build --no-daemon -x test

      - name: Start application and generate OpenAPI spec
        run: |
          # Start the application in the background
          ./gradlew bootRun --no-daemon &
          APP_PID=$!
          
          # Create output directory
          mkdir -p docs
          
          # Wait for application to start and be ready
          echo "‚è≥ Waiting for application to start on port 8700..."
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8700/actuator | grep -q "200"; then
              echo "‚úÖ Application is ready!"
              break
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting for application..."
            sleep 2
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚ùå Application failed to start within expected time"
            kill $APP_PID || true
            exit 1
          fi
          
          # Fetch and save the OpenAPI spec (application runs on port 8700)
          echo "üì• Fetching OpenAPI spec from http://localhost:8700/v3/api-docs..."
          if curl -v -s http://localhost:8700/v3/api-docs -H "Accept: application/yaml" -o docs/openapi.yaml; then
            if [ -s docs/openapi.yaml ]; then
              echo "‚úÖ OpenAPI spec generated successfully"
              echo "üìÑ Spec size: $(wc -c < docs/openapi.yaml) bytes"
              echo "üìÑ First 50 lines:"
              head -50 docs/openapi.yaml
            else
              echo "‚ùå OpenAPI spec file is empty"
              exit 1
            fi
          else
            echo "‚ùå Failed to fetch OpenAPI spec"
            exit 1
          fi
          
          # Kill the background application
          echo "üõë Stopping application..."
          kill $APP_PID || true
          wait $APP_PID 2>/dev/null || true

      - name: Add job summary
        run: |
          echo "## üìã OpenAPI Specification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ OpenAPI spec generated and published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìç **Available at:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Spec File:** \`docs/openapi.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- **API Documentation:** \`docs/api.html\`" >> $GITHUB_STEP_SUMMARY

      - name: Publish OpenAPI spec to docs/
        # avoid infinite loop on pushes created by this workflow
        if: ${{ github.actor != 'github-actions[bot]' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/openapi.yaml
          
          # Check if there are actual changes before committing
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to OpenAPI spec"
          else
            git commit -m "Update OpenAPI specification [skip ci]"
            git push
          fi
